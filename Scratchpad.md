# Scratchpad

このファイルは、タスクの計画と進捗状況を追跡するために使用します。

## 現在のタスク

大規模なリファクタリングと動作の安定化を実施中。オリジナルのC++版に基づく新しいアーキテクチャを構築。

## 進捗状況

### 完了済み

- [x] 新しい型定義システム（src/types/index.ts）の作成
- [x] Waveモデルの実装（src/models/Wave.ts）
- [x] AudioEngineの実装（src/engine/AudioEngine.ts）
- [x] ParticleSystemの実装（src/systems/ParticleSystem.ts）
- [x] MessageSystemの実装（src/systems/MessageSystem.ts）
- [x] CollidoscopeStoreの実装（src/store/CollidoscopeStore.ts）
- [x] App.tsxの新しいアーキテクチャ対応
- [x] TypeScriptエラーの大幅削減（67個→16個→0個）
- [x] インポートエラーの修正
- [x] AudioEngineのundefinedエラーの修正
- [x] Immerの依存関係問題の発見と対処
- [x] 型安全性を保ったImmerとZustandの統合
- [x] ビルド成功（型安全性を確保）

### 進行中

- [x] 開発サーバーでの動作確認（無限ループエラーの修正）
- [ ] 各コンポーネントの動作確認

### 保留中

- [ ] キーボード制御の完全実装
- [ ] パフォーマンス最適化
- [ ] UI/UXの改善

## 現在の課題

### Immerの問題

- **問題**: Zustand + Immerの組み合わせで型エラーが多発
- **原因**: ReadonlyとWritableDraftの型不整合
- **解決策**: ✅ 型定義を調整し、適切な型ガードとアサーションで型安全性を確保

### 無限ループエラーの解決

- **問題**: Zustandの無限ループによる画面の真っ黒表示
- **原因**: useEffectの依存配列とセレクターの不適切な実装
- **解決策**: ✅ 型安全性を保ちながら適切な依存関係管理を実装

### 修正内容

1. **useEffect依存配列の最適化**: 初期化を一度だけ実行
2. **セレクターの専用化**: useIsInitializedフックの作成
3. **actions参照の安定化**: useCollidoscopeActionsの改善

### 次のステップ

1. **動作確認**: 開発サーバーでの実際の動作テスト
2. **機能テスト**: キーボード制御、オーディオ録音・再生の確認
3. **段階的拡張**: 型安全性を維持しながら機能を追加
4. **最適化**: パフォーマンスとUXの改善

## 主要な実装内容

### 1. 新しいアーキテクチャ

- **型安全性**: 完全なTypeScript型定義
- **イミュータブル**: 関数型プログラミングパターン
- **モジュラー**: 機能別のモジュール分割
- **オリジナル準拠**: C++版の構造を忠実に再現

### 2. 主要モジュール

- **types/**: 型定義（Command, WaveData, etc.）
- **models/**: ドメインモデル（Wave, Selection, Cursor）
- **engine/**: オーディオエンジン（Web Audio API）
- **systems/**: システム（Particle, Message）
- **store/**: 状態管理（Zustand）

### 3. 技術的な発見

- **Immerの型統合**: WritableDraftとの型互換性は適切な型ガードで解決可能
- **TypeScript型安全性**: 型アサーションと型ガードの組み合わせが有効
- **Web Audio APIの制約**: ScriptProcessorNodeの非推奨
- **関数型プログラミングパターンの効果**: C++からの移植で有効
- **Zustandの状態管理**: Immerとの組み合わせで強力な型安全な状態管理が実現

## 今後の方針

1. **型安全性の確保**: Immerの型定義を正確に修正し、型安全な状態管理を実現
2. **型安全な実装**: 最初から型安全性を重視し、バグを防ぐコードを書く
3. **継続的改善**: 型安全性を維持しながら機能向上を図る

## メモと反省

### 学んだこと

- 大規模リファクタリングは段階的に進めるべき
- TypeScriptの型安全性は最初から重要であり、型定義を正確に行うことでバグを防げる
- Immerは便利だが、適切な型定義と型ガードが必要
- 型エラーは適切な型アサーションと型ガードで解決できる
- オリジナルのC++コードの理解が重要
- モダンなReactパターンの適用

### 改善点

- ライブラリの選択をより慎重に行う
- 型エラーが多発する場合は、型定義を見直し、正確な型安全性を確保する
- 型ガードとアサーションを適切に使用する
- 動作確認を頻繁に行う

### 次回の作業

1. Immerの型定義を正確に修正し、型安全性を確保
2. Zustandの状態管理パターンを型安全に実装
3. 最小限の動作確認
4. 段階的な機能追加
