# Collidoscope Web版 実装仕様

## 概要

オリジナルのCollidoscopeは、Raspberry Pi上で動作するC++製のアプリケーションと、Teensyマイクロコントローラーで制御される物理的なインターフェースで構成される楽器です。このドキュメントでは、その機能をWeb技術（React, TypeScript, Web Audio API）を用いて再現するための仕様を定義します。

**開発は段階的に行い、まずは単一のシンセエンジンを実装します。コンポーネントは再利用可能な形で設計し、最終的に2つ目のシンセエンジンを並べて配置できるように拡張可能にします。**

## 定数・設定値

**重要**: 以下の値はすべて設定可能な値として実装し、ユーザーが変更できるようにします。記載されている値はデフォルト値です。

### 音声設定（設定可能）

- **録音時間**: 2.0秒（デフォルト、0.1-10秒の範囲で設定可能）
- **チャンク数**: 150（デフォルト、1-1000の範囲で設定可能）
- **サンプルレート**: 44100Hz（Web Audio APIデフォルト、設定可能）
- **アテニュエーション**: -12dB（デフォルト、0.25118864315096）

### 選択範囲設定（設定可能）

- **選択開始位置**: 0-149（チャンクインデックス、チャンク数に依存）
- **選択サイズ**: 1-37（チャンク数、最大選択サイズとして設定可能）

### グラニュラーシンセシス設定（設定可能）

- **最大グレイン数**: 32（デフォルト、1-128の範囲で設定可能）
- **最小グレイン持続時間**: 640サンプル（約14.5ms at 44.1kHz、設定可能）
- **グレイン持続係数**: 1.0-8.0（デフォルト範囲、設定可能）
- **最大ボイス数**: 6（ポリフォニー、デフォルト、1-16の範囲で設定可能）

### エンベロープ設定（ASR）（設定可能）

- **アタック時間**: 0.01秒（10ms、デフォルト）
- **リリース時間**: 0.05秒（50ms、デフォルト）
- **サステインレベル**: 1.0（デフォルト）

### フィルター設定（設定可能）

- **最小カットオフ周波数**: 200Hz（デフォルト）
- **最大カットオフ周波数**: 22050Hz（デフォルト）
- **Qファクター**: 0.707（Butterworth特性、デフォルト）

### 色設定（設定可能）

- **Wave 1 (赤)**: RGB(243, 6, 62) / #F3063E（デフォルト）
- **Wave 2 (黄)**: RGB(255, 204, 0) / #FFCC00（デフォルト）
- **カーソル色**: 白 (#FFFFFF、デフォルト）

### 視覚設定（設定可能）

- **最大パーティクル数**: 150（デフォルト）
- **チャンクアニメーションフレーム数**: 3（デフォルト）

### MIDI設定（設定可能）

- **ピッチベンド範囲**: 0-149（デフォルト、チャンク数に依存）
- **CC制御マッピング**:
  - CC1: 選択サイズ（デフォルト）
  - CC2: グレイン持続時間（デフォルト）
  - CC4: ループオン/オフ（デフォルト）
  - CC5: 録音トリガー（デフォルト）
  - CC7: フィルターカットオフ（デフォルト）

### 設定管理要件

1. **設定ファイル**: JSON形式でエクスポート/インポート可能
2. **リアルタイム変更**: 再生中でも設定値を変更可能
3. **バリデーション**: 設定値の範囲チェックと依存関係チェック
4. **設定UI**: 設定パネルから各値を変更可能
5. **プリセット**: 複数の設定プリセットを保存・呼び出し可能

## 1. 音声入力

### 1.1. マイク入力

- **機能:** ユーザーのマイクから音声を取り込み、録音機能に渡します。
- **実装:**
  - `navigator.mediaDevices.getUserMedia` を使用してマイクへのアクセス許可をユーザーに求めます。
  - 許可された場合、マイクからの音声ストリームをWeb Audio APIの`MediaStreamAudioSourceNode`に接続します。
  - 録音機能が有効化された際に、このストリームを録音処理に渡します。

## 2. 音声録音と波形表示

### 2.1. 録音機能

- **機能:** マイクから入力された音声を指定された時間録音し、音声バッファに保存します。録音時間は設定可能です。
- **実装:**
  - 録音時間（デフォルト2秒）を設定ファイルまたはUIから変更可能な変数として保持します。
  - Web Audio APIの`AudioWorkletNode`を用いて、マイクからの音声を録音します（`ScriptProcessorNode`は非推奨のため使用しません）。
  - 録音された音声データは`AudioBuffer`として保持します。
  - 録音ボタンが押されると、既存の録音データを破棄し、新しい録音を開始します。
  - **チャンク処理**: 録音と同時に150個のチャンクに分割し、各チャンクの最大・最小振幅値を計算します。
  - **エンベロープ適用**: 録音開始時と終了時にフェードイン・フェードアウトを適用してクリックノイズを防止します。
  - **AudioWorklet**: 専用のワーカースレッドで録音処理を行い、メインスレッドをブロックしません。

### 2.2. 波形表示 (Wave)

- **機能:** 録音された音声データを視覚的な波形として画面に表示します。**初期実装では単一の波形（赤色）を表示し、将来的にはオリジナル同様、2つの独立した音声処理システムを実装できるように設計します。**

#### オリジナルの2音声処理システム構造

オリジナルのCollidoscopeは**2つの完全に独立した音声処理システムが一体化されたハードウェア**です。この2つの音声処理システムを併せて一つのCollidoscopeと呼んでいます：

- **音声処理システム0（赤色）**: RGB(243, 6, 62) / #F3063E
- **音声処理システム1（黄色）**: RGB(255, 204, 0) / #FFCC00
- **独立した音声処理**: 各音声処理システムに独立したグラニュラーシンセサイザー、フィルター、MIDI制御
- **画面分割**: 縦に2分割された表示レイアウト

#### Web版実装戦略

**Phase 1: 単一音声処理システム実装**（初期実装）

- 赤色波形（Wave 0）のみを実装
- 全機能を単一音声処理システムで完成
- UI/UXの最適化に集中

**Phase 2: デュアル音声処理システム拡張**（将来的な拡張）

- 黄色波形（Wave 1）の追加
- 状態管理の分離
- レイアウト調整（縦分割）
- **実装:**
  - 録音された`AudioBuffer`のデータを解析し、波形を描画します。
  - オリジナルの「チャンク」スタイルを再現するため、波形を150個のブロックに分割して、各ブロックの最大振幅と最小振幅をバーとして描画します。
  - `requestAnimationFrame`を使用して、滑らかな描画を実現します。
  - **チャンクアニメーション**: 新しいチャンクが作成される際にポップアップアニメーション（3フレームで完了）を実装します。
  - **選択範囲表示**: 選択されたチャンク範囲をハイライト表示します。
  - （将来的な拡張として）Wave 2は上下反転して表示します。

### 2.3. オシロスコープ表示

- **機能:** 現在再生されている音声の波形をリアルタイムで表示します。
- **実装:**
  - Web Audio APIの`AnalyserNode`を使用して、再生中の音声データの波形情報を取得します。
  - `requestAnimationFrame`ループ内で`getByteTimeDomainData`を呼び出し、取得したデータを`<canvas>`要素に描画します。
  - **ダウンサンプリング**: オーディオバッファサイズを4で除算してオシロスコープポイント数を決定します。

## 3. グラニュラーシンセシスエンジン

Collidoscopeの心臓部であるグラニュラーシンセサイザーをWeb Audio APIで再現します。

### 3.1. 音声の選択 (Selection)

- **機能:** ユーザーが録音された波形の一部を選択できるようにします。
- **実装:**
  - **UI:** オリジナルの操作感を再現するため、波形表示エリアの下に、ノブ付きの水平スライダーUIを実装します。
    - **選択範囲の開始位置 (Selection Start):** スライダーのノブ部分を水平にドラッグすることで制御します。
    - **選択範囲のサイズ (Selection Size):** スライダーのノブにマウスカーソルを乗せた状態で、マウスホイールを上下に回転させることで制御します。
  - **マッピング:**
    - 開始位置は0-149の範囲にマッピングします。
    - サイズは1-37（チャンク数）の範囲にマッピングします。

### 3.2. グレインの生成と再生 (Grain Engine)

- **機能:** 選択された音声範囲から「グレイン（音の粒）」を生成し、再生します。
- **実装:**
  - **グレイン構造**: 各グレインは以下の属性を持ちます：
    - `phase`: 読み取り位置（サンプル単位）
    - `rate`: 再生レート（ピッチ）
    - `alive`: 生存状態
    - `age`: 年齢（サンプル数）
    - `duration`: 持続時間（サンプル数）
  - **Hann窓エンベロープ**: Ross Bencina's "Implementing Real-Time Granular Synthesis"に基づくHann窓を適用します。
  - **線形補間**: サンプル間の線形補間を実装して音質を向上させます。
  - **ランダムオフセット**: 新しいグレインの開始位置に小さなランダムオフセットを追加してテクスチャを向上させます。
  - 以下のパラメータをWeb UIで制御できるようにします。
    - **ピッチ (Pitch):**
      - ピアノキーボードUIまたはPCのキーボード入力にマッピングします。
      - MIDIノート60（中央C）を基準とし、12平均律で周波数比を計算します。
      - `AudioBufferSourceNode.playbackRate`プロパティを変更することでピッチを変化させます。
    - **グレインの持続時間 (Grain Duration):**
      - スライダーUIで制御します（1〜8倍）。
      - この値が1より大きい場合、複数のグレインがオーバーラップして再生され、独特のテクスチャを生み出します。
      - **ポリフォニー**: 最大6ボイスまで同時再生をサポートします。
    - **ループ (Loop):**
      - ON/OFFを切り替えるトグルボタンを設置します。
      - ONの場合、選択範囲の再生をループさせます。
    - **フィルター (Filter):**
      - ローパスフィルターのカットオフ周波数をスライダーUIで制御します（200Hz〜22050Hz）。
      - `BiquadFilterNode`を使用し、`type`を`lowpass`に設定して実装します。カットオフ周波数は`frequency`パラメータで制御します。
      - 指数的なカーブを使用してより自然な周波数制御を実現します。

### 3.3. 再生カーソルとパーティクル表示

- **機能:**
  - ループ再生中に、現在の再生位置を示すカーソルを選択範囲上に表示します。
  - グレインの持続時間が長い場合に、視覚的なフィードバックとしてパーティクルを放出します。
- **実装:**
  - **カーソル:** `requestAnimationFrame`ループ内で、現在の再生時間に基づいてカーソルの位置を計算し、`<canvas>`上に描画します。
  - **パーティクル:** グレインの持続時間（`duration`）が1より大きい場合に、その値に応じてパーティクルの量や広がりを変化させて描画します。
  - **最大パーティクル数**: 150個（オリジナルと同様）
  - **パーティクル寿命**: フィルター設定に応じて調整

## 4. ユーザーインターフェース (UI)

### 4.1. 全体レイアウト

- **初期実装では、単一のシンセエンジンを画面中央に配置します。**
- 各エンジンには、波形表示エリア、ピアノキーボード、各種コントロール（スライダー、ボタン）を配置します。
- 将来的には、オリジナルの物理的なレイアウトを参考に、2つのシンセエンジンを左右（または上下）に配置できるように拡張します。

### 4.2. UIコンポーネント

- **ピアノキーボード:**
  - 画面上のキーをクリック、またはPCのキーボード（例: A,S,D,F...）を押すことで、対応するMIDIノートメッセージを生成し、シンセエンジンに送信します。
- **スライダー/ノブ:**
  - `Selection Start`, `Selection Size`, `Duration`, `Filter`の各パラメータを制御するために、React製のスライダーコンポーネントを使用します。
  - マウスドラッグやホイール操作で値を変更できるようにします。
- **ボタン:**
  - `Record`, `Loop On/Off`を制御するボタンを設置します。

### 4.3. キーボードショートカット（開発・デバッグ用）

- **R**: 録音開始
- **W/S**: 選択サイズの増減
- **A/D**: 選択開始位置の調整
- **スペース**: ループオン/オフ
- **9/0**: グレイン持続時間の調整
- **F**: フルスクリーン切り替え

## 5. 技術スタック

- **フロントエンド:** React 18, TypeScript 5+
- **音声処理:** Web Audio API（AudioWorklet、AudioWorkletNode）
- **UIコンポーネント:** MUI v7
- **状態管理:** Zustand
- **描画:** HTML5 Canvas API（波形・オシロスコープ・パーティクル）
- **ビルドツール:** Vite（高速開発・ビルド）

### 5.1. 対応ブラウザ（AudioWorklet対応）

- **Chrome:** 66+（AudioWorklet対応開始）
- **Firefox:** 76+（AudioWorklet対応開始）
- **Safari:** 14.1+（AudioWorklet対応開始）
- **Edge:** 79+（Chromiumベース）

### 5.2. AudioWorklet要件

- **HTTPS必須**: AudioWorkletはHTTPS環境でのみ動作します
- **Cross-Origin Isolation**: SharedArrayBufferを使用する場合は必要
- **Worker Context**: 音声処理はメインスレッドとは独立したワーカーコンテキストで実行

## 6. パフォーマンス考慮事項

- **AudioWorklet**: 専用ワーカースレッドでの非ブロッキング音声処理
- **メモリ管理**: オーディオバッファとグレインプールの効率的な管理
- **描画最適化**: requestAnimationFrameを使用した効率的な描画
- **グレイン管理**: 最大32グレインでのメモリプール管理
- **スレッド分離**: 音声処理とUI処理の完全分離によるレスポンシブ性確保
- **バッファサイズ**: AudioWorkletの128サンプルバッファで低レイテンシー実現
