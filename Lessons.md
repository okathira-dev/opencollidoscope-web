# Lessons

このファイルは、プロジェクト内で学んだ教訓や再利用可能な知識を記録するためのものです。
（`.cursor/rules/global.mdc`のルールに従って管理されています）

## User Specified Lessons

- Python venvの使用: `./venv`ディレクトリにあるPython仮想環境を常に使用（activate）してください。最初に`which uv`を実行して'uv'が利用可能かを確認し、利用可能であれば仮想環境をアクティベートした後に`uv pip install`を使用してパッケージをインストールしてください。利用できない場合は`pip`を使用してください。
- デバッグ情報: プログラム出力に役立つデバッグ情報を含めてください。
- ファイル編集の前提: ファイルを編集する前に必ずその内容を確認してください。
- Cursorの制限に関して: `git`や`gh`を使用する際に複数行のコミットメッセージが必要な場合は、まずメッセージをファイルに書き、`git commit -F <filename>`などのコマンドを使用してコミットしてください。その後ファイルを削除します。コミットメッセージとPRタイトルには「[Cursor] 」を含めてください。

## Cursor learned

- 検索結果: 国際的なクエリに対して異なる文字エンコーディング（UTF-8）を適切に処理することを確保してください。
- デバッグ情報の出力: パイプライン統合を改善するため、stderrにデバッグ情報を追加し、stdoutはメイン出力をクリーンに保ちます。
- seabornスタイル: matplotlibでseabornスタイルを使用する場合、最近のseabornバージョン変更により、'seaborn'ではなく'seaborn-v0_8'をスタイル名として使用してください。
- OpenAIモデル名: OpenAIのGPT-4（ビジョン機能付き）には'gpt-4o'をモデル名として使用してください。
- 最新情報の検索: 最新ニュースを検索する場合は、前年ではなく現在の年（2025）を使用するか、単に「recent」キーワードを使用して最新情報を取得してください。

## Project Specific Lessons

- C++音声処理からWeb移植の重要ポイント:
  - **グラニュラーシンセシス**: オリジナルのPGranular.hには32グレイン、6ボイス、Hann窓エンベロープの詳細実装があり、Web Audio APIでの再現時にこれらの具体的な値と仕様を参考にすること
  - **チャンク処理**: 150チャンク、2秒録音、最大37チャンク選択という具体的な数値がオリジナルの操作感に重要
  - **色とアニメーション**: Wave1赤(#F3063E)、Wave2黄(#FFCC00)、3フレームのポップアニメーションなど、視覚的な詳細がユーザー体験に影響する
  - **エンベロープ設定**: アタック10ms、リリース50ms、-12dBアテニュエーションなどの具体的な音響パラメータがオリジナルの音質再現に必須
  - **MIDI制御マッピング**: ピッチベンド（選択位置0-149）、CC1（選択サイズ1-37）、CC2（持続時間）など、物理コントローラーとの互換性のための具体的なマッピング
- 設計書の図式化とMermaidダイアグラム:
  - **Mermaidダイアグラムの効果的な活用**: アスキーアート図よりも視覚的に理解しやすく、複雑なアーキテクチャを階層的に表現可能
  - **技術設計書でのMermaid使用のベストプラクティス**: 全体アーキテクチャ（graph TB）、処理フロー（graph LR）、色分けでコンポーネント識別、サブグラフでモジュール境界明確化
  - **設計書の構造化**: 概要→アーキテクチャ→詳細設計の順で構成し、図と詳細説明の適切な配置により実装時に参照しやすい形で情報整理
- 設定値のコンフィグ化設計:
  - **ハードコーディングからの脱却**: 仕様に出現する具体的な値（チャンク数150、最大グレイン数32など）はすべて設定可能な値として設計することで、拡張性と柔軟性を向上
  - **設定管理の階層化**: 音声設定、グラニュラーシンセシス設定、視覚設定、MIDI設定など、機能別に階層化された設定構造により管理しやすさを向上
  - **リアルタイム設定反映**: 設定変更時に即座に反映される仕組み（useEffect + Zustand）により、ユーザビリティを向上
  - **設定の永続化**: localStorage を使用した設定の保存・復元により、ユーザーのカスタマイズ体験を向上
  - **プリセット管理**: 複数の設定プリセットの保存・呼び出し機能により、様々な用途に応じた設定の切り替えを可能に
- 最新Web Audio API対応（AudioWorklet）:
  - **ScriptProcessorNode廃止**: 非推奨APIの回避により、将来的な互換性を確保。AudioWorkletNodeを使用することで最新ブラウザに対応
  - **専用ワーカースレッド**: AudioWorkletによりメインスレッドをブロックしない音声処理を実現し、UIのレスポンシブ性を向上
  - **セキュリティ要件**: HTTPS必須、ユーザージェスチャー必要など、現代のWebセキュリティ要件に対応した設計
  - **ブラウザ対応範囲**: Chrome 66+、Firefox 76+、Safari 14.1+という明確な対応ブラウザ範囲の設定により、実装の複雑性を削減
  - **エラーハンドリング強化**: AudioWorklet固有のエラー（セキュアコンテキスト、ブラウザ対応など）に対する包括的なエラーハンドリング設計
- オリジナルCollidoscopeのアーキテクチャ分析:
  - **2つの独立した音声処理システム**: `NUM_WAVES=2`により、オリジナルのCollidoscopeは2つの完全に独立した音声処理システムが一体化されたハードウェアであることが判明。この2つの音声処理システムを併せて一つのCollidoscopeと呼んでいる
  - **段階的実装戦略**: 初期実装では単一音声処理システム（赤色波形）のみを実装し、全機能を完成させてから第2音声処理システム（黄色波形）を追加する戦略が有効
  - **コンポーネント独立性**: 各音声処理システムに対してWave、PGranular、Filter、MIDIコントローラーなど、すべてのコンポーネントが独立して実装されている
  - **レイアウト設計**: 画面が縦に2分割される設計（`mSelectionBarHeight = mWindowHeight / NUM_WAVES`）により、2つの音声処理システムが並行して表示される
  - **色分け**: 音声処理システム0（赤色）と音声処理システム1（黄色）の明確な色分けにより、ユーザーが2つの音声処理システムを区別できる

## Lessons管理ルール

1. **目的**: このファイルは、プロジェクト作業中に学んだ教訓や再利用可能な知識を記録し、共有するためのものです。

2. **更新方法**:
   - 新しいLessonを発見したら、適切なセクションに追加してください
   - 既存のLessonを修正・改善する場合は、その理由を記載してください
   - 各Lessonは簡潔かつ具体的に記述し、可能であれば例を含めてください

3. **分類**:
   - User Specified Lessons: ユーザーが明示的に指定した重要なレッスン
   - Cursor learned: AIが作業中に学んだレッスン
   - Project Specific Lessons: 特定のプロジェクトに関連するレッスン（必要に応じて追加）

4. **他のファイルとの連携**:
   - Scratchpad.mdでタスクを実行する際、このLessons.mdを参照して過去の教訓を活かしてください
   - 新しいLessonを発見したら、現在のタスクを中断せずに、タスク完了後にこのファイルを更新してください
